version: 2.1

orbs:
  python: circleci/python@0.3.2
  k3d: devopsspiral/k3d@0.1.2
jobs:
  build-and-test:
    executor: python/default
    environment:
      PYTHONPATH=./src
    steps:
      - checkout
      - python/load-cache
      - python/install-deps
      - python/save-cache
      - python/test
  test-on-k8s:
    executor: python/default
    environment:
      PYTHONPATH=./src
    steps:
      - setup_remote_docker
      - checkout
      - python/load-cache
      - python/install-deps
      - python/install-deps:
          dependency-file: testcases/requirements.txt
      - python/save-cache
      - k3d/k3d-helpers
      - k3d/k3d-up:
          cluster-name: circleci-k8s
      - k3d/k3d-run:
          name: Run kubectl
          command: |
            helm repo add stable https://kubernetes-charts.storage.googleapis.com
            git clone https://github.com/kyma-incubator/octopus
            docker cp octopus repo:/repo/
            helm install octopus /repo/octopus/chart/octopus/

            helm install grafana stable/grafana
            helm install grafana2 stable/grafana
            sleep 30
            kubectl get pods
      - k3d/k3d-down:
          cluster-name: circleci-k8s
workflows:
  main:
    jobs:
      - build-and-test
      - test-on-k8s
  #     - test-coverage
  #     - code-quality
  # publish:
  #   jobs:
  #     - publish-to-pypi